# Amazon RDS/Aurora Logs

 You can [publish database instance logs to Amazon CloudWatch Logs](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_LogAccess.Procedural.UploadtoCloudWatch.html). Then, you can perform real-time analysis of the log data, store the data in highly durable storage, and manage the data with the CloudWatch Logs Agent.

## Prerequisites
Make sure your database logs are enabled. Some databases logs are not enabled by default, and you need to update your database parameters to enable the logs.

Refer to [How do I enable and monitor logs for an Amazon RDS MySQL DB instance?](https://aws.amazon.com/premiumsupport/knowledge-center/rds-mysql-logs/) to learn how to output logs to CloudWatch Logs.

The table below lists the requirements for RDS/Aurora MySQL parameters.

| Parameter            | Requirement                                                  |
| -------------- | ------------------------------------------------------------ |
| Audit Log      | The database instance must use a custom option group with the `MARIADB_AUDIT_PLUGIN` option. |
| General log    | The database instance must use a custom parameter group with the parameter setting `general_log = 1` to enable the general log. |
| Slow query log | The database instance must use a custom parameter group with the parameter setting `slow_query_log = 1` to enable the slow query log. |
| Log output     | The database instance must use a custom parameter group with the parameter setting `log_output = FILE` to write logs to the file system and publish them to CloudWatch Logs. |

## Create log ingestion
You can create a log ingestion into Amazon OpenSearch Service either by using the Centralized Logging with OpenSearch console or by deploying a standalone CloudFormation stack.

!!! important "Important"

    - The RDS and CloudWatch region must be the same as the Centralized Logging with OpenSearch solution region.
    - The Amazon OpenSearch Service index is rotated on a daily basis by default, and you can adjust the index in the Additional Settings.

### Using the Centralized Logging with OpenSearch Console
1. Sign in to the Centralized Logging with OpenSearch Console.
2. In the navigation pane, under **Log Analytics Pipelines**, choose **Service Log**.
3. Choose the **Create a log ingestion** button.
4. In the **AWS Services** section, choose **Amazon RDS**.
5. Choose **Next**.
6. Under **Specify settings**, choose **Automatic** or **Manual** for **RDS log enabling**. The automatic mode will detect your RDS log configurations and ingest logs from CloudWatch.
    - For **Automatic mode**, choose the RDS cluster from the dropdown list.
    - For **Manual mode**, enter the **DB identifier**, select the **Database type** and input the CloudWatch log location in **Log type and location**.
    - (Optional) If you are ingesting RDS/Aurora logs from another account, select a [linked account](../link-account/index.md) from the **Account** dropdown first.
7. Choose **Next**.
8. In the **Specify OpenSearch domain** section, select an imported domain for **Amazon OpenSearch domain**.
9. Choose **Yes** for **Sample dashboard** if you want to ingest an associated templated Amazon OpenSearch Service dashboard.
10. You can change the **Index Prefix** of the target Amazon OpenSearch Service index if needed. The default prefix is the `Database identifier`.
11. In the **Log Lifecycle** section, input the number of days to manage the Amazon OpenSearch Service index lifecycle. The Centralized Logging with OpenSearch will create the associated [Index State Management (ISM)](https://opensearch.org/docs/latest/im-plugin/ism/index/) policy automatically for this pipeline.
12. Choose **Next**.
13. Add tags if needed.
14. Choose **Create**.

### Using the CloudFormation Stack
This automated AWS CloudFormation template deploys the *Centralized Logging with OpenSearch - RDS Log Ingestion* solution in the AWS Cloud.

|                      | Launch in AWS Console                                        | Download Template                                            |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| AWS Regions | [![Launch Stack](../../images/launch-stack.png)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?templateURL=https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/RDSLog.template){target=_blank} | [Template](https://{{ bucket }}.s3.amazonaws.com/centralized-logging-with-opensearch/{{ version }}/RDSLog.template) |
| AWS China Regions    | [![Launch Stack](../../images/launch-stack.png)](https://console.amazonaws.cn/cloudformation/home#/stacks/new?templateURL=https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/RDSLog.template){target=_blank} | [Template](https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/RDSLog.template) |

{%
include-markdown "include-cw-cfn-common.md"
%}

## View dashboard

The dashboard includes the following visualizations.

| Visualization Name              | Source Field                                                                                                                                                                                                                                                                                                                                                                                                                                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Controller                      | <ul><li> db-identifier </li><li> sq-table-name </li></ul>                                                                                                                                                                                                                                                                                                                                                                                   | This visualization allows users to filter data based on the db-identifier and sq-table-name fields.                                                                                                                                                                                                                                                                                                                                                 |
| Total Log Events Overview       | <ul><li> db-identifier </li><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                       | This visualization presents an overview of the total log events for the specified database ('db-identifier'). It helps monitor the frequency of various log events.                                                                                                                                                                                                                                                                                 |
| Slow Query History              | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization shows the historical data of slow query log events. It allows you to track the occurrences of slow queries and identify potential performance issues.                                                                                                                                                                                                                                                                            |
| Average Slow Query Time History | <ul><li> Average sq-duration </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                     | This visualization depicts the historical trend of the average duration of slow queries ('sq-duration'). It helps in understanding the database's performance over time and identifying trends related to slow query durations.                                                                                                                                                                                                                     |
| Total Slow Queries              | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization provides the total count of slow queries in the log events. It gives an immediate view of how many slow queries have occurred during a specific time period, which is useful for assessing the database's performance and potential bottlenecks.                                                                                                                                                                                 |
| Average Slow Query Duration     | <ul><li> Average sq-duration </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                     | This visualization shows the average duration of slow queries ('sq-duration') over time. It is valuable for understanding the typical performance of slow queries in the database.                                                                                                                                                                                                                                                                  |
| Top Slow Query IP               | <ul><li> sq-ip </li><li> sq-duration </li></ul>                                                                                                                                                                                                                                                                                                                                                                                             | This visualization highlights the IP addresses ('sq-ip') associated with the slowest queries and their respective durations ('sq-duration'). It helps identify sources of slow queries and potential areas for optimization.                                                                                                                                                                                                                        |
| Slow Query Scatter Plot         | <ul><li> sq-duration </li><li> sq-ip </li><li> sq-query </li></ul>                                                                                                                                                                                                                                                                                                                                                                          | This scatter plot visualization represents the relationship between the duration of slow queries ('sq-duration'), the IP addresses ('sq-ip') from which they originated, and the actual query content ('sq-query'). It helps in understanding query performance patterns and identifying potential issues related to specific queries and their sources.                                                                                            |
| Slow Query Pie                  | <ul><li> sq-query </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                | This pie chart visualization shows the distribution of slow queries based on their content ('sq-query'). It provides an overview of the types of queries causing performance issues, allowing you to focus on optimizing specific query patterns.                                                                                                                                                                                                   |
| Slow Query Table Name Pie       | <ul><li> sq-table-name </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                           | This pie chart visualization displays the distribution of slow queries based on the table names ('sq-table-name') they access. It helps identify which tables are affected by slow queries, enabling targeted optimization efforts for specific tables.                                                                                                                                                                                             |
| Top Slow Query                  | <ul><li> sq-query </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                | This visualization presents the slowest individual queries based on their content ('sq-query'). It is helpful in pinpointing specific queries that have the most significant impact on performance, allowing developers and administrators to focus on optimizing these critical queries.                                                                                                                                                           |
| Slow Query Logs                 | <ul><li> db-identifier </li><li> sq-db-name </li><li> sq-table-name </li><li> sq-query</li><li> sq-ip </li><li> sq-host-name </li><li> sq-rows-examined </li><li> sq-rows-sent </li><li> sq-id </li><li> sq-duration </li><li> sq-lock-wait </li></ul>                                                                                                                                                                                      | This visualization provides detailed logs of slow queries, including database ('sq-db-name'), table ('sq-table-name'), query content ('sq-query'), IP address ('sq-ip'), host name ('sq-host-name'), rows examined ('sq-rows-examined'), rows sent ('sq-rows-sent'), query ID ('sq-id'), query duration ('sq-duration'), and lock wait time ('sq-lock-wait'). It is beneficial for in-depth analysis and troubleshooting of slow query performance. |
| Total Deadlock Queries          | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization shows the total number of deadlock occurrences based on the log events. Deadlocks are critical issues that can cause database transactions to fail, and monitoring their frequency is essential for ensuring database stability.                                                                                                                                                                                                 |
| Deadlock History                | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization displays the historical data of deadlock occurrences based on the log events. Understanding the pattern of deadlocks over time can help identify recurring issues and take preventive measures to reduce their impact on the database.                                                                                                                                                                                           |
| Deadlock Query Logs             | <ul><li> db-identifier </li><li>log-detail</li><li>deadlock-ip-1</li><li>deadlock-action-1</li><li>deadlock-os-thread-handle-1</li><li>deadlock-query-1</li><li>deadlock-query-id-1</li><li>deadlock-thread-id-1</li><li>deadlock-user-1</li><li>deadlock-action-2</li><li>deadlock-ip-2</li><li>deadlock-os-thread-handle-2</li><li>deadlock-query-2</li><li>deadlock-query-id-2</li><li>deadlock-thread-id-2</li><li>deadlock-user-2</ul> | This visualization provides detailed logs of deadlock occurrences                                                                                                                                                                                                                                                                                                                                                                                   |
| Total Error Logs                | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization presents the total count of error log events. Monitoring error logs helps identify database issues and potential errors that need attention and resolution.                                                                                                                                                                                                                                                                      |
| Error History                   | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization shows the historical data of error log events. Understanding the error patterns over time can aid in identifying recurring issues and taking corrective actions to improve the database's overall health and stability.                                                                                                                                                                                                          |
| Error Logs                      | <ul><li> db-identifier </li><li>err-label</li><li>err-code</li><li>err-detail</li><li>err-sub-system</li><li>err-thread</li></ul>                                                                                                                                                                                                                                                                                                             | This visualization displays the error logs generated by the AWS RDS instance. It provides valuable insights into any errors, warnings, or issues encountered within the database system, helping to identify and troubleshoot problems effectively. Monitoring error logs is essential for maintaining the health and reliability of the database.                                                                                                  |
| Audit History                   | <ul><li> log event </li></ul>                                                                                                                                                                                                                                                                                                                                                                                                               | This visualization presents the audit history of the AWS RDS instance. It tracks the various log events and activities related to database access, modifications, and security-related events. Monitoring the audit logs is crucial for ensuring compliance, detecting unauthorized access, and keeping track of changes made to the database.                                                                                                      |
| Audit Logs                      | <ul><li> db-identifier </li><li>audit-operation</li><li>audit-ip</li><li>audit-query</li><li>audit-retcode</li><li>audit-connection-id</li><li>audit-host-name</li><li>audit-query-id</li><li>audit-user</li></ul>                                                                                                                                                                                                                            | This visualization provides an overview of the audit logs generated by the AWS RDS instance. It shows the operations performed on the database, including queries executed, connection details, IP addresses, and associated users. Monitoring audit logs enhances the security and governance of the database, helping to detect suspicious activities and track user actions.                                                                     |

### Sample Dashboard

{%
include-markdown "../include-dashboard.md"
%}

[![rds-db]][rds-db]

[rds-db]: ../../images/dashboards/rds-db.png
