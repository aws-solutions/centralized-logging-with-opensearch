# VPC Flow Logs
[VPC Flow Logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html) enable you to capture information about the IP traffic going to and from network interfaces in your VPC.

## Create log ingestion
You can create a log ingestion into Amazon OpenSearch Service either by using the Centralized Logging with OpenSearch console or by deploying a standalone CloudFormation stack.

!!! important "Important"
    - Centralized Logging with OpenSearch supports VPCs who publish the flow log data to an Amazon S3 bucket or a CloudWatch log group. When publishing to S3, The S3 Bucket region must be the same as the Centralized Logging with OpenSearch solution region.
    - The Amazon OpenSearch Service index is rotated on a daily basis by default, and you can adjust the index in the Additional Settings.

### Using the Centralized Logging with OpenSearch Console
1. Sign in to the Centralized Logging with OpenSearch Console.
2. In the navigation pane, under **Log Analytics Pipelines**, choose **Service Log**.
3. Choose the **Create a log ingestion** button.
4. In the **AWS Services** section, choose **VPC Flow Logs**.
5. Choose **Next**.
6. Under **Specify settings**, choose **Automatic** or **Manual** for **VPC Flow Log enabling**. The automatic mode will enable the VPC Flow Log and save the logs to a centralized S3 bucket if logging is not enabled yet.
    - For **Automatic mode**, choose the VPC from the dropdown list.
    - For **Manual mode**, enter the **VPC Name** and **VPC Flow Logs location**.
    - (Optional) If you are ingesting VPC Flow logs from another account, select a [linked account](../link-account/index.md) from the **Account** dropdown list first.
 7. Under **Log Source**, select **S3** or **CloudWatch** as the source.
 8. Choose **Next**.
 9. In the **Specify OpenSearch domain** section, select an imported domain for **Amazon OpenSearch domain**.
 10. Choose **Yes** for **Sample dashboard** if you want to ingest an associated built-in Amazon OpenSearch Service dashboard.
 11. You can change the **Index Prefix** of the target Amazon OpenSearch Service index if needed. The default prefix is your VPC name.
 12. In the **Log Lifecycle** section, enter the number of days to manage the Amazon OpenSearch Service index lifecycle. The Centralized Logging with OpenSearch will create the associated [Index State Management (ISM)](https://opensearch.org/docs/latest/im-plugin/ism/index/) policy automatically for this pipeline.
 13. Choose **Next**.
 14. Add tags if needed.
 15. Choose **Create**.

### Using the standalone CloudFormation Stack
This automated AWS CloudFormation template deploys the *Centralized Logging with OpenSearch - VPC Flow Logs Ingestion* solution in the AWS Cloud.

|                      | Launch in AWS Console                                        | Download Template                                            |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| AWS Standard Regions | [![Launch Stack](../../images/launch-stack.png)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?templateURL=https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/VPCFlowLog.template){target=_blank} | [Template](https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/VPCFlowLog.template) |
| AWS China Regions    | [![Launch Stack](../../images/launch-stack.png)](https://console.amazonaws.cn/cloudformation/home#/stacks/new?templateURL=https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/VPCFlowLog.template){target=_blank} | [Template](https://{{ bucket }}.s3.amazonaws.com/{{ solution }}/{{ version }}/VPCFlowLog.template) |

{%
include-markdown "include-cfn-common.md"
%}

## View dashboard

The dashboard includes the following visualizations.

| Visualization Name           | Source Field                                                                                                                                                                                                                                 | Description                                                                                                                                                                                                                                                    |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Global Filters               | <ul><li> account-id </li><li> region </li><li> vpc-id </li><li> subnet-id </li><li> action </li><li> flow-direction </li><li> log-status </li><li> protocol-code </li><li> type </li></ul>                                                   | The charts are filtered according to Account ID, Region, VPC ID and other conditions.                                                                                                                                                                     |
| Total Requests               | <ul><li> log event </li></ul>                                                                                                                                                                                                                | Shows the total number of network requests logged by VPC Flow Logs during a selected time period.                                                                                                                                                              |
| Request History              | <ul><li> log event </li></ul>                                                                                                                                                                                                                | Presents a bar chart that displays the distribution of events over time.                                                                                                                                                                                       |
| Requests By VPC ID           | <ul><li> vpc-id </li></ul>                                                                                                                                                                                                                   | Displays the proportional breakdown of network requests by source VPC using a pie chart.                                                                                                                                                                       |
| Total Requests By Action     | <ul><li> action </li></ul>                                                                                                                                                                                                                   | Displays the total volume of requests segmented by action over time.                                                                                                                                                                                           |
| Total Bytes                  | <ul><li> bytes</li></ul>                                                                                                                                                                                                                     | Provides visibility into overall bandwidth usage and traffic patterns across the monitored VPCs, subnets, network interfaces and security groups.                                                                                                              |
| Total Packets                | <ul><li> packets </li></ul>                                                                                                                                                                                                                  | Displays total logged packets over time to visualize trends, surges and dips.                                                                                                                                                                                  |
| Bytes Metric                 | <ul><li> bytes</li><li>flow-direction</li></ul>                                                                                                                                                                                              | Shows the distribution of incoming (Ingress) and outgoing (Egress) network traffic volumes in bytes across the range of flows logged by VPC Flow Logs over a time period.                                                                                      |
| Requests By Direction        | <ul><li> flow-direction</li></ul>                                                                                                                                                                                                            | Provides visibility into the proportional composition of incoming versus outgoing requests.                                                                                                                                                                    |
| Requests By Direction        | <ul><li> flow-direction </li></ul>                                                                                                                                                                                                           | Displays the total number of network flows logged by VPC Flow Logs segmented by traffic direction - Ingress vs Egress.                                                                                                                                         |
| Requests By Type             | <ul><li> type </li></ul>                                                                                                                                                                                                                     | Shows the volume of flows for each type. This provides visibility into the protocol composition of network requests traversing the environment.                                                                                                                |
| Top Source Bytes             | <ul><li> srcaddr</li><li> bytes</li></ul>                                                                                                                                                                                                    | Displays the source IP addresses transmitting the highest outbound volume of data during the selected time period.                                                                                                                                             |
| Top Destination Bytes        | <ul><li> dstaddr</li><li> bytes</li></ul>                                                                                                                                                                                                    | Enables you to monitor and analyze outbound traffic from your VPC to external destinations.                                                                                                                                                                    |
| Top Source Requests          | <ul><li>srcaddr </li></ul>                                                                                                                                                                                                                   | Allows you to see which resources inside your VPC are initiating external requests.                                                                                                                                                                            |
| Top Destination Requests     | <ul><li> dstaddr</li></ul>                                                                                                                                                                                                                   | Allows you to see which external hosts are being contacted most by your VPC resources.                                                                                                                                                                         |
| Requests by Protocol         | <ul><li> protocol-code</li></ul>                                                                                                                                                                                                             | Displays network flows logged by VPC Flow Logs segmented by traffic type - TCP, UDP, ICMP etc.                                                                                                                                                                 |
| Requests by Status           | <ul><li> log-status</li></ul>                                                                                                                                                                                                                | Provides a breakdown of network flows by their traffic status - Accepted, Rejected or Other.                                                                                                                                                                   |
| Top Sources AWS Services     | <ul><li> pkt-src-aws-service</li></ul>                                                                                                                                                                                                       | Show the proportional distribution of flows originating from top AWS sources like S3, CloudFront, Lambda, etc. during the selected time period.                                                                                                                |
| Top Destination AWS Services | <ul><li> pkt-dst-aws-service</li></ul>                                                                                                                                                                                                       | Provide visibility into IP traffic going to and from AWS services located outside your VPC. By enabling flow logs on VPC subnets/interfaces and filtering on traffic with an ACCEPT action, you can view outbound flows from your VPC to various AWS services. |
| Network Flow                 | <ul><li>srcaddr</li><li>dstaddr</li></ul>                                                                                                                                                                                                    | Allows you to view information about the IP traffic going to and from network interfaces in your VPC.                                                                                                                                                          |
| Heat Map                     | <ul><li>srcaddr</li><li>dstaddr</li></ul>                                                                                                                                                                                                    | Offers a visual summary of connections between source and destination IPs in your flow log data.                                                                                                                                                               |
| Egress Traffic Path          | <ul><li>traffic-path</li></ul>                                                                                                                                                                                                               | Allows you to enable flow logging on VPC network interfaces to capture information about all IP traffic going to and from that interface.                                                                                                                      |
| Search                       | <ul><li>@timestamp</li><li>account-id</li><li>vpc-id</li><li>	flow-direction</li><li>action</li><li>protocol-code</li><li>srcaddr</li><li>scaport</li><li>dstaddr</li><li>dstport</li><li>bytes</li><li>packets</li><li>log-status</li></ul>| Searching through the detailed flow log data allows pinpoint analysis of traffic around security events, network issues, changes in usage patterns, and more.                                                                                                  |

### Sample Dashboard

{%
include-markdown "../include-dashboard.md"
%}

[![vpcflow-db]][vpcflow-db]

[vpcflow-db]: ../../images/dashboards/vpcflow-db.png
